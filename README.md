# DCモータ制御シールドV1.0
<img src="/images/Product_photo.jpg" width="300px">

DCモータ制御シールドV1.0は、ブラシ付きDCモータFA-130RAの位置/速度/トルク制御が可能なNucleo-64用シールドです。  
「モータ制御のプログラムの中身はどうなっているのか」や、「どのゲインを調整することで制御性能が改善されるのか」といった制御の学習にご利用いただけます。  
電子部品は全て実装済みではんだ付けが不要であるため、組立に大きな労力を割く必要がなくモータ制御の学習に集中できます。また、サンプルプログラムは[mbed](https://developer.mbed.org/users/y2kb/code/DCMotorControlShieldV1_0/)および System workbench for STM32(SW4STM32) の2種類の環境で提供しており、お好みの環境で学習することができます。

### ハードウェアの特徴
- 12-bit(4096)/回転の高分解能な磁気式エンコーダAS5600を搭載
- ユーザーが使用可能な半固定抵抗を4個用意しており、プログラムを書き換えることで指令値やゲインを動的に変動させるといったことが可能
- モータの電源はNucleoに接続したUSB端子からの供給もしくはシールド上のUSB端子からの供給のどちらかを選ぶことが可能

### ソフトウェアの特徴
- サンプルプログラムの制御系は位置/速度制御を行う加速度メジャーループ(制御周期200us)と電流マイナーループ(制御周期50us)のカスケード制御方式を採っており、いずれの制御器も全てソフトウェアで構成しているため、制御器の全てのゲインにアクセス可能
- 指令値や応答値、ゲインなどのパラメータはNucleo上のST-Linkを通じてPCに送ることができ、ターミナル([Tera Term](https://osdn.net/projects/ttssh2/))やシリアルプロッタ(例：[Arduino IDE](https://www.arduino.cc/en/Main/Software)、[CPLT](http://www.datatecno.co.jp/cplt/cplt-download.htm))を使用することでリアルタイムにパラメータを表示可能
- 制御系が不安定になりモータが暴走した際は自動的にモータと制御演算を停止する発散防止機能を搭載

## 販売
○○にて販売中

## 概要図
<img src="/images/Overview.jpg" width="600px">

## 内容物
<img src="/images/Package_contents.jpg" width="600px">

## 別途ご用意いただく物
- Nucleo-64ボード  
  動作確認済：[NUCLEO-F411RE](http://www.st.com/en/evaluation-tools/nucleo-f411re.html)
- マブチ DCモーター FA-130RA  
  ※ **モーターマウント/2段プーリー付き** のものをご用意ください。

## 組立方法

#### 1. 内容物の確認  
内容物が全て入っているか確認します。特にネオジム磁石は見落としがちなので注意してください。

#### 2. モーターマウントの取り付け  
マブチ DCモーター FA-130RAに入っているモータマウントを基板裏側から、ナット ― 基板 ― モータマウント ― 平ワッシャ ― 小ネジ の順になるように固定してください。このとき、モータの出力軸が基板上のシルクの向きと同じ方向になるようにしてください。  
<img src="/images/Assemble_MotorMount.jpg" width="350px">

#### 3. エンコーダ用磁石の取り付け  
マブチ DCモーター FA-130RAに入っている2段プーリーに両面テープや瞬間接着剤を用いて磁石を取り付けます。このとき磁石はしっかりと固定してください。固定が不十分な状態ですと制御発散時等に磁石が外れる可能性があります。また、プーリーと磁石の中心のズレが1mm以内(可能であれば0.25mm以内)に収まるようにしてください。ズレが大きいと位置情報の読み取りエラーや取得する位置情報の精度悪化に繋がります。  
<img src="/images/Assemble_Pulley_Magnet.jpg" width="200px">

#### 4. プーリーの取り付け  
モータの出力軸にプーリーを取り付けます。このとき、モータの外装部とプーリーが接触しない程度にプーリーを挿しこんでください。  
<img src="/images/Assemble_Motor_Pulley.jpg" width="350px">

#### 5. モータの取り付け  
モータをモータマウントに取り付け、モータの配線をターミナルに取り付けます。
配線がショートしないよう被覆が剥かれた部分をニッパ等で適切な長さに切った後、ターミナルに配線を挿しこんで固定します。
このとき、ターミナルに取り付ける配線の色に注意してください。  
<img src="/images/Assemble_Motor.jpg" width="350px">

## サンプルプログラム
- SW4STM32  
  本ページの"Software"フォルダ内にあります

- mbed  
  [DCMotorControlShieldV1_0](https://developer.mbed.org/users/y2kb/code/DCMotorControlShieldV1_0/)

なお、HALライブラリ、FreeRTOS、CMSIS-OS等のライブラリ以外の
プログラムはMITライセンスです。

## サンプルプログラムの利用方法

大半のユーザーはモータ制御の設定とパラメータ出力に関わる"Src/control.c"内の以下の関数の参照・変更で十分だと思われます。

関数名  |  説明
--|--
`static void MajorControlLoop(void)` |  加速度メジャーループ(制御周期：200[us])<br>ユーザーはこの関数内で位置/速度/トルク制御といったモードや指令値・ゲインを変更できます。<br>また、電流制御の使用可否やゲインも設定できます。
`static void MinorControlLoop(void)`  |  電流マイナーループ(制御周期：50[us])
`static void PositionControl(float PosCmd, float VelCmd, float P_Gain, float I_Gain, float D_Gain)`  |  位置制御モードに設定する関数<br>引数は順に、位置指令値、速度指令値(位置指令値の微分値)、Pゲイン、Iゲイン、Dゲイン
`static void VelocityControl(float VelCmd, float P_Gain, float I_Gain)`  |  速度制御モードに設定する関数<br>引数は順に、速度指令値、Pゲイン、Iゲイン
`static void TorqueControl(float Command)`  |  トルク制御モードに設定する関数<br>引数はトルク指令値
`static void configCurrentControl(bool isEnabled, float P_Gain, float I_Gain)`  |  電流マイナーループの設定<br>引数は順に、電流マイナーループの使用可否、Pゲイン、Iゲイン
`void SerialCommunicationTask(void const *argument)`  |  低優先度のUARTによるシリアル通信タスク<br>この関数内の`printf`関数を書き換えることでNucleo状のST-Linkを介してPCに各種パラメータ(例：指令値、応答値、ゲイン)を送信できる

その他の詳細はサンプルプログラムの説明書(本ページの"Software/doc/index.html")を参照してください。

### 出力結果例
サンプルプログラムは位置指令モード、位置指令値は矩形波と正弦波を周期的に繰り返すようなプログラムになっており、シリアルプロッタを用いて以下に示すようにステップ応答と1[Hz]の周波数応答を得ることができます。  
<img src="/images/Result_Default.png" width="500px">

## 制御性能の改善

※この項は制御理論のお話です。

制御性能を高めるためには、モータが目標値に素早く応答する目標値応答特性と、制御系のモデル化誤差やパラメータ変動、負荷トルクといった外乱による影響を抑圧する外乱抑圧応答特性を同時に向上する必要があります。  
さて、サンプルプログラムでは位置制御器にはPID制御器、速度制御器にはPI制御器、電流制御器にはPI制御器を搭載しています。こうした古典的な制御器は
指令値と応答値の偏差のみからモータ出力参照値を生成する1自由度制御であり、1つのパラメータ(偏差)を用いて目標値応答特性と外乱抑圧応答特性の向上という2つの目標を達成しようとしているため、上記の目標値応答特性と外乱抑圧応答特性はトレードオフの関係になっており、様々なゲインチューニング法を用いて良好なゲインを設定することで制御性能をある程度までは高められますが、それでも頭打ちになってしまいます。  
この問題に対し、未知の外乱やパラメータ変動による不安定化が起こりにくいロバスト制御と呼ばれる制御手法があります。代表的なロバスト制御手法にはH∞制御(H Infinity control)がありますが、ここでは容易に実装でき、かつ強力に外乱を抑圧できる「外乱オブザーバ (Disturbance observer : DOB)」を用いて制御を行ってみます。  
外乱オブザーバとはモータ出力参照値(系への入力)とモータの応答値(系の出力)から外乱を推定する観測器であり、推定した外乱をフィードバックすることで外乱による影響を抑圧することができます。外乱オブザーバを付加することで、位置/速度制御器の目標値応答特性とは独立して外乱抑圧応答特性を高めることができます。すなわち、2自由度制御系を構成でき、ロバストな加速度制御系を実現できます。  
以下に外乱オブザーバを実装した場合の応答値を示します。なお、位置制御器のP、Dゲインはサンプルプログラムと同等にし、Iゲインは0(外乱オブザーバに積分制御要素が含まれるため)、外乱オブザーバのカットオフ周波数は500[rad/sec]としました。  
<img src="/images/Result_withDOB.png" width="500px">  
先の項のサンプルプログラムと比較して応答値がしっかりと目標値に追従していることがわかります。
